<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prolific Dyadic Chat</title>
    <script src="/socket.io/socket.io.js"></script>

    <!-- jsPsych core -->
    <script src="https://unpkg.com/jspsych@7.3.3/dist/index.browser.js?v=core"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/dist/style.css?v=core">

    <!-- Local plugins -->
    <script src="/plugins/jspsych-survey-html-form-lite.js?v=v7class"></script>
    <script src="/plugins/jspsych-instructions-lite.js?v=v7class"></script>
    <script src="/plugins/jspsych-dyadic-chat.js?v=vG6h-uipatch3d"></script>

    <style>
      body { margin:0; background:#000; color:#fff; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      .jspsych-content { color:#fff; }
      .jspsych-btn { background:#1f1f22; color:#fff; border:1px solid #555; border-radius:10px; padding:10px 14px; }
      a, p, li, h1, h2, h3 { color:#fff; }
      .consent-box { margin-top:20px; max-height:55vh; overflow:auto; padding:12px; border:1px solid #444; border-radius:10px; background:#0b0b0b; text-align:left; max-width:1400px; margin-left:auto; margin-right:auto; font-family: 'Arial', 'Helvetica', sans-serif; font-size:16px; line-height:1.6; }
      .consent-actions { margin-top:12px; }
      .consent-actions label { display:flex; align-items:center; gap:8px; }
      .instr { text-align:justify; max-width:1400px; margin:0 auto; padding: 0 10px; }
      .instr ul { line-height:1.6; }
      .instr h2 { margin-top:0; }
      .instr-page-top { margin-top: 24px; }
      .instr li { margin: 8px 0; }
      .instr strong { color: #8bd5ff; }
  .consent-box h2 { margin: 0 0 12px 0; }
</style>
  </head>
  <body>
    <script>
      const jsPsych = initJsPsych();
      const __qp = new URLSearchParams(location.search);
      const pidFromUrl = __qp.get('PID') || __qp.get('PROLIFIC_PID') || 'DEBUG_LOCAL';

      const CONSENT_HTML = `
        <div class="consent-box">
          <h2>Consent</h2>
          <p>Please read the information below. By checking the box, you confirm that you consent to participate in this study.</p>
          <ul>
            <li>I agree to the anonymous use of the data in research presentations, publications, and online interactive sites to illustrate the findings.</li>
            <li>I agree that the collected data could be used in related follow-up studies.</li>
            <li>I agree to the use of the data in a not-for-profit anonymous corpus for research purposes which others will have access to.</li>
            <li>I agree to not share any personal or identifying information.</li>
            <li>I understand that I can withdraw at any time by closing the window.</li>
          </ul>
          <div class="consent-actions">
            <label><input type="checkbox" name="consent" required> I have read the information and I consent to participate in the study.</label>
          </div>
        </div>`;

      // Function to generate instructions based on question type
      function generateInstructions(questionType, maxTurns) {
        const baseInstructions = `
<div class="instr instr-aesthetic instr-page-top" style="margin-top: 28px;">
  <style>
    .instr-aesthetic .nice { margin: 0; padding-left: 1.2em; line-height: 1.6; }
    .instr-aesthetic li { margin: 6px 0; }
    .instr-aesthetic ol[type="a"] { margin-top: 6px; }
    .instr-aesthetic h2 { margin-bottom: 10px; }
  </style>
  <h2>Instructions</h2>
  <ol class="nice">
    <li>This is a collaborative task. You will be connected with another participant via chat to solve a question.</li>
    <li>You have to chat and collaborate with your partner in order to solve the question correctly.</li>
    ${getQuestionTypeSpecificInstructions(questionType)}
    <li>You can submit an answer only after you have sent ${maxTurns} total messages to your partner.</li>
    <li>Taking Turns:
      <ol type="a">
        <li>Send a message only after your partner replies.</li>
        <li>No two consecutive messages from the same person.</li>
      </ol>
    </li>
    <li>You may zoom in on the image to inspect details.</li>
    <li>After the messages are completed, select the best option you think is correct and click "Submit Answer".</li>
    <li>Do not share personal information.</li>
  </ol>
  
  <!-- <div style="margin: 60px auto; width: 100%; height: 2px; background: linear-gradient(to right, transparent, #8bd5ff, transparent);"></div>
  
  <div style="margin-top: 50px; text-align: center;">
    <h2 style="margin-bottom: 20px; color: #fff;">Task Example</h2>
    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
      <div style="text-align: center;">
        <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
        <img src="/inst_img/${questionType}_your_view_1.png" 
             alt="Your view example" 
             style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
        <p style="font-size: 16px; color: #8bd5ff; margin-top: 5px;">You see 2 lamps</p>
      </div>
      <div style="text-align: center;">
        <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
        <img src="/inst_img/${questionType}_partner_view_1.png"
             alt="Partner's view example" 
             style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
        <p style="font-size: 16px; color: #ff6b6e; margin-top: 5px;">Partner sees 3 lamps</p>
      </div>
    </div>
    <div style="margin-top: 15px; font-size: 18px; color: #d0d4d9;">
      <p><strong>Question:</strong> "How many lamps are there in total?"</p>
      <p><strong>Options:</strong></p>
        <ol type="a" style="text-align: center; list-style-position: inside; color: #8bd5ff;">
          <li>4</li>
          <li>3</li>
          <li>5</li>
          <li>6</li>
        </ol>
      <p><strong>Answer:</strong> 4 (not 5!) - You need to communicate with your partner to avoid counting the same lamp twice.</p>
    </div>
  </div> -->

  <!-- Divider -->
  <div style="margin: 60px auto; width: 100%; height: 2px; background: linear-gradient(to right, transparent, #8bd5ff, transparent);"></div>

  <div style="margin-top: 50px; margin-bottom: 50px; text-align: center;">
    <h2 style="margin-bottom: 20px; color: #fff;">Task Interface</h2>
    <img src="/inst_img/interface.png" alt="Task Interface" max-width: 900px; height: auto;">
  </div>
  
  <p>Click "Begin Task" when you are ready.</p>
</div>
`;
        return baseInstructions;
      }

      function getQuestionTypeSpecificInstructions(questionType) {
        switch(questionType) {
          case 'counting':
            return `<li style="color: #8bd5ff;"><strong>Task Details (Read Carefully):</strong>
              <ol type="i">
                <li style="color: #8bd5ff;"><strong>In this task, you and your partner will each see a different view of the same room. Some objects might be visible in both views, while other objects might be visible in only one view.</strong></li>
                <li style="color: #8bd5ff;"><strong>Both of you will be given a multiple choice question about the room with only one correct answer.</strong></li>
                 
                
                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #fff;">Task Example (Counting)</h2>
                  <div style="margin-top: 15px; font-size: 18px; color: #d0d4d9;">
                    <p><strong>Question:</strong> What is the total number of lamps in the room?</p>
                    <p><strong>Options:</strong></p>
                      <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <span>a. 4</span>
                        <span>b. 3</span>
                        <span>c. 5</span>
                        <span>d. 6</span>
                      </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>



                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_2.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 16px; color: #8bd5ff; margin-top: 5px;">You see 2 lamps</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_2.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 16px; color: #ff6b6e; margin-top: 5px;">Partner sees 3 lamps</p>
                    </div>
                  </div>
                  <div style="margin-top: 15px; font-size: 18px; color: #d0d4d9;">
                    <!-- <p><strong>Question:</strong> "What is the total number of lamps in the room?"</p>
                    <p><strong>Options:</strong></p>
                      <ol type="a" style="text-align: center; list-style-position: inside; color: #8bd5ff;">
                        <li>4</li>
                        <li>3</li>
                        <li>5</li>
                        <li>6</li>
                      </ol> -->
                    <p><strong>Answer:</strong> a. 4 <br> (not 5! - You need to communicate with your partner to avoid counting the same lamp twice.)</p>
                  </div>
                </div>
                
                
                <!-- <li style="color: #8bd5ff;"><strong>Example Question: "What is the total number of lamps in the room?"</strong><br><strong>&nbsp&nbspOptions:</strong></li>
                 <ol type="a" style="margin-left: 20px;">
                   <li style="color: #8bd5ff;"><strong>4</strong></li>
                   <li style="color: #8bd5ff;"><strong>3</strong></li>
                   <li style="color: #8bd5ff;"><strong>1</strong></li>
                   <li style="color: #8bd5ff;"><strong>2</strong></li>
                 </ol> -->
                <li style="color: #8bd5ff;"><strong>You have to prevent overcounting or undercounting the lamps by discussing with your partner.</strong></li>
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If you correctly answer the question, you will be rewarded with a bonus payment.</strong></li>
              </ol>
              </li>`;
            // return `<li><strong>Counting Task:</strong> <span style="color: #8bd5ff;">For instance, if the question is "How many lamps are there in the room?", you might see 1 lamp in your view and your partner might see 2 lamps in their view. Its also possible that you both might be seeing the same lamp, so you have to prevent overcounting or undercounting the lamps by discussing with your partner.</span></li>`;
          case 'spatial':
          return `<li style="color: #8bd5ff;"><strong>Task Details (Read Carefully):</strong>
              <ol type="i">
                <li style="color: #8bd5ff;"><strong>In this task, you and your partner will each see a different view of the same room. Some objects might be visible in both views, while other objects might be visible in only one view.</strong></li>
                <li style="color: #8bd5ff;"><strong>One of you will be given a multiple choice question about the room with only one correct answer.</strong></li>
                <li style="color: #8bd5ff;"><strong>The task of the person who is given the question is to seek help from their partner to answer the question correctly. And the task of the other person is to provide help to their partner.</strong></li>
                <li style="color: #8bd5ff;"><strong>You can either be the person who is given the question or the person who is helping the partner.</strong></li>
                

                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #fff;">Task Example (Spatial Understanding)</h2>

                  <div style="margin-top: 15px; font-size: 18px; color: #d0d4d9;">
                    <div style="display: flex; gap: 20px; justify-content: center;">
                    <!-- <p><strong>Question for you:</strong> From your perspective, where is the light green cushioned sofa with a rounded back, fabric upholstery, and a cylindrical armrest on the right side located?</p> -->
                    <!-- <div style="display: flex; gap: 80px; justify-content: center;"> -->
                      <div style="flex: 1;">
                        <p><strong>Question for you:</strong> From your perspective, in which direction is the light green cushioned sofa with a rounded back, and a cylindrical armrest located?</p>
                        <p><strong>Options for you:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #8bd5ff;">
                          <li>left</li>
                          <li>behind-right</li>
                          <li>front-right</li>
                          <li>behind</li>
                        </ol>
                      </div>
                      <div style="flex: 1; align-content: center;">
                        <p style="font-size: 24px;"><strong style="color: #ff6b6e;">Your partner's task is to help you answer the question correctly.</strong></p>
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_2.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 18px; margin-top: 5px;"><b style="color: #8bd5ff;">Answer:</b> a. left</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_2.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>
                  
                </div>
                
                
                <li style="color: #8bd5ff;"><strong>The object mentioned in the question will not be in the view of the person who has been given the question.</strong></li>
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If the question is answered correctly, both you and your partner will be rewarded with a bonus payment.</strong></li> 
                
              </ol>
              </li>`;

          case 'anchor':
            return `<li style="color: #8bd5ff;"><strong>Task Details (Read Carefully):</strong>
              <ol type="i">
                <li style="color: #8bd5ff;"><strong>In this task, you and your partner will each see a different view of the same room. Some objects might be visible in both views, while other objects might be visible in only one view.</strong></li>
                <li style="color: #8bd5ff;"><strong>Both of you will be given a multiple choice question about the room with only one correct answer.</strong></li>
                 

                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #fff;">Task Example (Anchor Object Recognition)</h2>

                  <div style="margin-top: 15px; font-size: 18px; color: #d0d4d9;">
                    <p><strong>Question:</strong> Which object appears in both your view and your partner's view of the room?</p>
                    <div style="display: flex; gap: 20px; justify-content: center;">
                      <div>
                        <p><strong>Options for you:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #8bd5ff;">
                          <li>tall white wooden cabinet with a single compartment</li>
                          <li>ceramic circular plant container</li>
                          <li>square canvas wall art with gray background</li>
                          <li>light pink fabric sofa with three cushions and rounded armrests</li>
                        </ol>
                      </div>
                      <div>
                        <p><strong style="color: #ff6b6e;">Options for your partner:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #8bd5ff;">
                          <li>dark brown wooden cabinet with multiple small square compartments</li>
                          <li>tall light brown wooden cabinet with two compartments</li>
                          <li>white ceramic plant pot with some brown soil</li>
                          <li>artwork with abstract patterns and colors</li>
                        </ol>
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_1.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 18px; margin-top: 5px;"><b style="color: #8bd5ff;">Answer:</b> c. square canvas wall art with gray background</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_1.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 18px; margin-top: 5px;"><b style="color: #ff6b6e;">Answer:</b> d. artwork with abstract patterns and colors</p>
                    </div>
                  </div>
                  
                </div>
                
                
                
                <!--<li style="color: #8bd5ff;"><strong>Example Question: "Which object appears in both your and your partner's views of the room?"</strong><br><strong>&nbsp&nbspOptions:</strong></li>
                 <ol type="a" style="margin-left: 20px;">
                   <li style="color: #8bd5ff;"><strong>rectangular black desk with white metal legs</strong></li>
                   <li style="color: #8bd5ff;"><strong>large tall wide light wood shelf with multiple compartments</strong></li>
                   <li style="color: #8bd5ff;"><strong>tall beige floor lamp with cylindrical fabric shade and metal or wooden base</strong></li>
                   <li style="color: #8bd5ff;"><strong>bed with green textured mattress and wooden frame with four cylindrical legs</strong></li>
                 </ol> -->
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If you correctly answer the question, you will be rewarded with a bonus payment.</strong></li>
              </ol>
              </li>`;
          case 'relative_distance':
            return `<li style="color: #8bd5ff;"><strong>Task Details (Read Carefully):</strong>
              <ol type="i">
                <li style="color: #8bd5ff;"><strong>In this task, you and your partner will each see a different view of the same room. Some objects might be visible in both views, while other objects might be visible in only one view.</strong></li>
                <li style="color: #8bd5ff;"><strong>Both of you will be given a two-choice question about the room with only one correct answer.</strong></li>
                 
                
                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #fff;">Task Example (Relative Distance)</h2>

                  <div style="margin-top: 15px; font-size: 18px; color: #d0d4d9;">
                    <p><strong>Question:</strong> Which object among the options is closer to the sofa (long rectangular shape, rounded armrests, light beige patterned fabric)?</p>
                    <!-- <p><strong>Options:</strong></p> -->
                      <ol type="a" style="text-align: center; list-style-position: inside; color: #8bd5ff;">
                        <li>rectangular light natural wood shelf with multiple square compartments holding small decor and paper stacks</li>
                        <li>tall light brown wooden shelf with two vertical columns containing books and small decorative items</li>
                      </ol>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>
                  
                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_2.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 16px; color: #8bd5ff; margin-top: 5px;">You see the sofa and the rectangular shelf with multiple square compartments</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_2.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 16px; color: #ff6b6e; margin-top: 5px;">Partner sees the sofa and the tall light brown wooden shelf with two vertical columns</p>
                    </div>
                  </div>
                  <div style="margin-top: 15px; margin-bottom: 30px; font-size: 18px; color: #d0d4d9;">
                    <!-- <p><strong>Question:</strong> "Which item is closer to the sofa (long rectangular shape, rounded armrests, light beige patterned fabric)?"</p>
                    <p><strong>Options:</strong></p>
                      <ol type="a" style="text-align: left; list-style-position: inside; color: #8bd5ff;">
                        <li>rectangular light natural wood shelf with multiple square compartments holding small decor and paper stacks</li>
                        <li>tall light brown wooden shelf with two vertical columns containing books and small decorative items</li>
                      </ol> -->
                    <p><strong>Answer:</strong> a. rectangular light natural wood shelf with multiple square compartments holding small decor and paper stacks.</p>
                  </div>
                </div>
                
                
                
                <!-- <li style="color: #8bd5ff;"><strong>Example Question: "Which of the following objects is closer to the white wooden bookcase with two compartments, containing a pink item and small objects?"</strong><br><strong>&nbsp&nbspOptions:</strong></li>
                 <ol type="a" style="margin-left: 20px;">
                   <li style="color: #8bd5ff;"><strong>white floor lamp with a tall silver metal stand and conical fabric shade</strong></li>
                   <li style="color: #8bd5ff;"><strong>tall white wooden cabinet with two glass-paneled doors showing shelves inside</strong></li>
                 </ol> -->
                <li style="color: #8bd5ff;"><strong>The object mentioned in the question will be in both views. However, one of the objects in the options will only be in your view and the other object in the options will only be in your partner's view.</strong></li>
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If you correctly answer the question, you will be rewarded with a bonus payment.</strong></li>
              </ol>
              </li>`;
        case 'perspective_taking':
          return `<li style="color: #8bd5ff;"><strong>Task Details (Read Carefully):</strong>
              <ol type="i">
                <li style="color: #8bd5ff;"><strong>In this task, you and your partner will each see a different view of the same room. Some objects might be visible in both views, while other objects might be visible in only one view.</strong></li>
                <li style="color: #8bd5ff;"><strong>One of you will be given a multiple choice question about the room with only one correct answer.</strong></li>
                <li style="color: #8bd5ff;"><strong>The task of the person who is given the question is to seek help from their partner to answer the question correctly. And the task of the other person is to provide help to their partner.</strong></li>
                <li style="color: #8bd5ff;"><strong>You can either be the person who is given the question or the person who is helping the partner.</strong></li>
                

                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #fff;">Task Example (Perspective Taking)</h2>

                  <div style="margin-top: 15px; font-size: 18px; color: #d0d4d9;">
                    <div style="display: flex; gap: 20px; justify-content: center;">
                    <!-- <p><strong>Question for you:</strong> From your perspective, where is the light green cushioned sofa with a rounded back, fabric upholstery, and a cylindrical armrest on the right side located?</p> -->
                    <!-- <div style="display: flex; gap: 80px; justify-content: center;"> -->
                      <div style="flex: 1; align-content: center;">
                        <p style="font-size: 24px;"><strong style="color: #ff6b6e;">Your task is to help your partner answer the question correctly.</strong></p>
                      </div>
                      <div style="flex: 1;">
                        <p><strong>Question for your partner:</strong> From your partner's perspective, where is the tall black wooden shelf with multiple square compartments filled with books and items located?</p>
                        <p><strong>Options for you:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #8bd5ff;">
                          <li>left</li>
                          <li>behind-right</li>
                          <li>front-right</li>
                          <li>behind</li>
                        </ol>
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_2.png" 
                          alt="Your view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 18px; margin-top: 5px;"><b style="color: #8bd5ff;">Answer:</b> a. left</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_2.png"
                          alt="Partner's view example" 
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>
                  
                </div>
                
                
                <li style="color: #8bd5ff;"><strong>The object mentioned in the question will be in the view of the person who has been given the question.</strong></li>
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If the question is answered correctly, both you and your partner will be rewarded with a bonus payment.</strong></li> 
                
              </ol>
              </li>`;
          case 'all_types':
            return `
            <li><strong>Counting Task:</strong> <span style="color: #8bd5ff;">For instance, if the question is "How many lamps are there in the room?", you might see 1 lamp in your view and your partner might see 2 lamps in their view. Its also possible that you both might be seeing the same lamp, so you have to prevent overcounting or undercounting the lamps by discussing with your partner.</span></li>
            <!-- <li><strong>Spatial Task:</strong> <span style="color: #ff6666;">For instance, if the question is "Where is the red chair located?", you might see the chair on the left side of your view while your partner sees it on the right side of their view. You need to discuss the spatial relationships and positions to determine the correct answer.</span></li> -->
            <!-- <li><strong>Anchor Task:</strong> <span style="color: #ff6666;">For anchor questions, you might see objects in different positions. Discuss the anchor object and its location with your partner.</span></li> -->
            <!-- <li><strong>Relative Distance Task:</strong> <span style="color: #ff6666;">For relative distance questions, you might see objects in different distances. Discuss the relative distance between the objects with your partner.</span></li> -->
            <!-- <li><strong>Other Tasks:</strong> <span style="color: #ff6666;">You and your partner will see different perspectives of the same scene and need to work together to solve the question correctly.</span></li> -->`; 
          default:
            return `<li>You and your partner will see different perspectives of the same scene and need to work together to solve the question correctly.</li>`;
        }
      }

      // Instructions are generated dynamically based on server QUESTION_TYPE
const consentTrial = { 
  type: jsPsychSurveyHtmlForm, 
  html: CONSENT_HTML, 
  button_label: "Continue",
  on_load: function() {
    // Track consent page start time globally
    if (typeof window !== 'undefined' && window.consentPageStartTime === undefined) {
      window.consentPageStartTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
    }
  }
};
      // Fetch server config first, then initialize jsPsych
      async function initializeExperiment() {
        let serverConfig = { questionType: 'all_types', maxTurns: 10 };
        
        try {
          const response = await fetch('/api/config');
          serverConfig = await response.json();
          console.log('[DyadicChat] Server config:', serverConfig);
        } catch (error) {
          console.warn('[DyadicChat] Failed to fetch server config, using defaults:', error);
        }

        const instructionsTrial = { 
          type: jsPsychInstructions, 
          pages: [generateInstructions(serverConfig.questionType, serverConfig.maxTurns)], // Use server config
          show_clickable_nav: true, 
          button_label_next: "Begin Task", 
          button_label_previous: "Back",
          on_load: function() {
            // Track instructions page start time
            if (typeof window !== 'undefined' && window.instructionsPageStartTime === undefined) {
              window.instructionsPageStartTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
            }
          }
        };

        const chatTrial = {
          type: jsPsychDyadicChat,
          socketUrl: window.location.origin,
          prolific: { PID: pidFromUrl },
          min_turns: serverConfig.maxTurns, // Use server config
          goal_question: '',
          answer_options: ['A','B','C','D'],
          wait_timeout_sec: 120,
          image_url: '',
          question_type: serverConfig.questionType // Use server config
        };

        jsPsych.run([consentTrial, instructionsTrial, chatTrial]);
      }

      // Initialize the experiment
      initializeExperiment();
    </script>
  </body>
</html>
