<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prolific Dyadic Chat</title>
    <script src="/socket.io/socket.io.js"></script>

    <!-- jsPsych core -->
    <script src="https://unpkg.com/jspsych@7.3.3/dist/index.browser.js?v=core"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/dist/style.css?v=core">

    <!-- Local plugins -->
    <script src="/plugins/jspsych-survey-html-form-lite.js?v=v7class"></script>
    <script src="/plugins/jspsych-instructions-lite.js?v=v7class"></script>
    <script src="/plugins/jspsych-dyadic-chat.js?v=vG6h-uipatch3d"></script>

    <style>
      body { margin:0; background:#f5f5f5; color:#1a1a1a; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      .jspsych-content { color:#1a1a1a; }
      .jspsych-btn { background:#f0f0f0; color:#1a1a1a; border:1px solid #d0d0d0; border-radius:10px; padding:10px 14px; }
      a, p, li, h1, h2, h3 { color:#1a1a1a; }
      .consent-box { margin-top:20px; max-height:55vh; overflow:auto; padding:28px; border:1px solid #d0d0d0; border-radius:10px; background:#ffffff; text-align:left; max-width:1400px; margin-left:auto; margin-right:auto; font-family: 'Arial', 'Helvetica', sans-serif; font-size:16px; line-height:1.6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); color:#1a1a1a; }
      .consent-box * { color:#1a1a1a; }
      .consent-box h2 { margin: 0 0 12px 0; color:#1a1a1a; }
      .consent-box p { color:#1a1a1a; }
      .consent-box ul { color:#1a1a1a; }
      .consent-box li { color:#1a1a1a; }
      .consent-actions { margin-top:12px; }
      .consent-actions label { display:flex; align-items:center; gap:8px; color:#1a1a1a; }
      .instr { text-align:justify; max-width:1400px; margin:0 auto; padding: 0 10px; }
      .instr ul { line-height:1.6; }
      .instr h2 { margin-top:0; color:#1a1a1a; }
      .instr-page-top { margin-top: 24px; }
      .instr li { margin: 8px 0; }
      .instr strong { color: #0066cc; }
      .dc-spinner { width: 20px; height: 20px; border: 3px solid rgba(0,0,0,.2); border-top-color: #333; border-radius: 50%; animation: dcspin 0.9s linear infinite; margin: 20px auto; }
      @keyframes dcspin { to { transform: rotate(360deg); } }
      /* Override any jsPsych default styles for consent page */
      .jspsych-content .consent-box,
      .jspsych-content .consent-box *,
      .jspsych-survey-html-form .consent-box,
      .jspsych-survey-html-form .consent-box * {
        color: #1a1a1a !important;
      }
</style>
  </head>
  <body>
    <script>
      const jsPsych = initJsPsych();
      window.jsPsych = jsPsych; // Make jsPsych available globally for fallback
      const __qp = new URLSearchParams(location.search);
      const pidFromUrl = __qp.get('PID') || __qp.get('PROLIFIC_PID') || 'DEBUG_LOCAL';

      const CONSENT_HTML = `
        <div class="consent-box">
          <h2>Consent</h2>
          <p>Please read the information below. By checking the box, you confirm that you consent to participate in this study.</p>
          <ul>
            <li>I agree to the anonymous use of the data in research presentations, publications, and online interactive sites to illustrate the findings.</li>
            <li>I agree that the collected data could be used in related follow-up studies.</li>
            <li>I agree to the use of the data in a not-for-profit anonymous corpus for research purposes which others will have access to.</li>
            <li>I agree to not share any personal or identifying information.</li>
            <li>I understand that I can withdraw at any time by closing the window.</li>
          </ul>
          <div class="consent-actions">
            <label><input type="checkbox" name="consent" required> I have read the information and I consent to participate in the study.</label>
          </div>
        </div>`;

      // Function to generate role-specific instructions
      function generateRoleSpecificInstructions(role, questionType, maxTurns) {
        if (role === 'answerer') {
          return generateAnswererInstructions(questionType, maxTurns);
        } else {
          return generateHelperInstructions(questionType, maxTurns);
        }
      }

      // Function to generate answerer instructions
      function generateAnswererInstructions(questionType, maxTurns) {
        const baseInstructions = `
<div class="instr instr-aesthetic instr-page-top" style="margin-top: 28px;">
  <style>
    .instr-aesthetic .nice { margin: 0; padding-left: 1.2em; line-height: 1.6; }
    .instr-aesthetic li { margin: 6px 0; }
    .instr-aesthetic ol[type="a"] { margin-top: 6px; }
    .instr-aesthetic h2 { margin-bottom: 10px; }
  </style>
  <h2>Instructions</h2>
  <ol class="nice">
    <li>This is a collaborative task. You will be connected with another participant via chat to solve a question.</li>
    <li>You have to communicate and collaborate with your partner in order to solve the question correctly.</li>
    <li>Task Details (Read Carefully):
      <ol type="a">
        <li>You and your partner will each see a different view of the same room. Some objects might be visible in both views, while other objects might be visible in only one view.</li>
        <li><strong style="color: #0066cc;">You are the Answerer.</strong></li>
        <li>You will be given a multiple choice question about the room with one correct answer. Given the question, you have to seek help from your partner (Helper) to answer the question correctly.</li>
        <li>Your partner is the Helper and will help you answer the question correctly.</li>
        <li>Overall, the goal is to discuss and collaborate with your partner to find the correct answer.</li>
        ${getQuestionTypeSpecificInstructions(questionType)}
      </ol>
    </li>
    <br>
    <br>
    <li>You and your partner will have a maximum of ${maxTurns} messages each that you can send to each other.</li>
    <li>Note (taking turns in the conversation):
      <ol type="a">
        <li>You have to send the first message.</li>
        <li>You cannot send consecutive messages, you have to wait for your partner to respond before sending another message.</li>
      </ol>
    </li>
    <li>You can choose to terminate the conversation early by pressing the “End Chat and Answer Now” button if you think you have found the correct answer.</li>
    <li>After the conversation is complete (either by choosing to terminate, or by reaching the maximum number of allowed messages), you must select the best option you think is correct and click "Submit Answer".</li>
    <li style="color: #cc0000;"><strong style="color: #cc0000;">IMPORTANT: You must engage in a proper conversation and make a meaningful attempt to solve the question. If you terminate prematurely or do not engage properly, payment might not be issued.</strong></li>
    <li style="color: #cc0000;"><strong style="color: #cc0000;">IMPORTANT: Please avoid long pauses or delays in your chat responses during the task to maintain a smooth conversation. Do not exit or refresh the page until you’ve fully completed the task.</strong></li>
    <li>You will attempt 3 total questions in the entire session.</li>
    <li>You can zoom into the image to inspect details.</li>
    <li>Do not share personal information or engage in small talk. Please try to be respectful in your messages, and avoid using colloquial or slang language . </li>
    <li>Ensure that you have a stable internet connection throughout the conversations. If you get disconnected, your answer will not be recorded. </li>
  </ol>

  <!-- Divider -->
  <div style="margin: 60px auto; width: 100%; height: 2px; background: linear-gradient(to right, transparent, #0066cc, transparent);"></div>

  <div style="margin-top: 50px; margin-bottom: 50px; text-align: center;">
    <h2 style="margin-bottom: 20px; color: #1a1a1a;">Task Interface</h2>
    <img src="/inst_img/interface.png" alt="Task Interface" style="max-width: 100%; height: auto;">
  </div>

  <p>Click "Begin Task" when you are ready.</p>
</div>
`;
        return baseInstructions;
      }

      // Function to generate helper instructions
      function generateHelperInstructions(questionType, maxTurns) {
        const baseInstructions = `
<div class="instr instr-aesthetic instr-page-top" style="margin-top: 28px;">
  <style>
    .instr-aesthetic .nice { margin: 0; padding-left: 1.2em; line-height: 1.6; }
    .instr-aesthetic li { margin: 6px 0; }
    .instr-aesthetic ol[type="a"] { margin-top: 6px; }
    .instr-aesthetic h2 { margin-bottom: 10px; }
  </style>
  <h2>Instructions</h2>
  <ol class="nice">
    <li>This is a collaborative task. You will be connected with another participant via chat to solve a question.</li>
    <li>You have to communicate and collaborate with your partner in order to solve the question correctly.</li>
    <li>Task Details (Read Carefully):
      <ol type="a">
        <li>You and your partner will each see a different view of the same room. Some objects might be visible in both views, while other objects might be visible in only one view.</li>
        <li><strong style="color: #cc0000;">You are the Helper.</strong></li>
        <li>Your partner is the Answerer and theywill receive a multiple choice question about the room.</li>
        <li>Your task is to help your partner (Answerer) to answer the question correctly. You won't receive any question yourself.</li>
        <li>Overall, the goal is to discuss and collaborate with your partner to find the correct answer.</li>
        ${getQuestionTypeSpecificInstructions(questionType)}
      </ol>
    </li>
    <br>
    <br>
    <li>You and your partner will have a maximum of ${maxTurns} messages each that you can send to each other.</li>
    <li>Note (taking turns in the conversation):
      <ol type="a">
        <li>Your partner will send the first message.</li>
        <li>You cannot send consecutive messages, you have to wait for your partner to respond before sending another message.</li>
      </ol>
    </li>
    <li>After the conversation is complete (either by your partner choosing to terminate early, or by reaching the maximum number of allowed messages), your partner will select the best option they think is correct and submit their answer.</li>
    <li>Once your partner has submitted their answer, you will move on to the next question.</li>
    <li style="color: #cc0000;"><strong style="color: #cc0000;">IMPORTANT: You must engage in a proper conversation and make a meaningful attempt to help your partner. If you do not engage properly, payment might not be issued.</strong></li>
    <li style="color: #cc0000;"><strong style="color: #cc0000;">IMPORTANT: Please avoid long pauses or delays in your chat responses during the task to maintain a smooth conversation. Do not exit or refresh the page until you've fully completed the task.</strong></li>
    <li>You will attempt 3 total questions in the entire session.</li>
    <li>You can zoom into the image to inspect details.</li>
    <li>Do not share personal information or engage in small talk. Please try to be respectful in your messages, and avoid using colloquial or slang language.</li>
    <li>Ensure that you have a stable internet connection throughout the conversations. If you get disconnected, your answer will not be recorded.</li>
  </ol>

  <!-- Divider -->
  <div style="margin: 60px auto; width: 100%; height: 2px; background: linear-gradient(to right, transparent, #cc0000, transparent);"></div>

  <div style="margin-top: 50px; margin-bottom: 50px; text-align: center;">
    <h2 style="margin-bottom: 20px; color: #1a1a1a;">Task Interface</h2>
    <img src="/inst_img/interface.png" alt="Task Interface" style="max-width: 100%; height: auto;">
  </div>

  <p>Click "Begin Task" when you are ready.</p>
</div>
`;
        return baseInstructions;
      }

      function getQuestionTypeSpecificInstructions(questionType) {
        switch(questionType) {
          case 'counting':
            return `<li style="color: #0066cc;"><strong>The task is to find the count of a given object.</strong></li>
                <li style="color: #0066cc;"><strong>You and your partner must make sure that you are counting the total number of unique instances of that object in the room while preventing overcounting or undercounting.</strong></li>


                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #1a1a1a;">Task Example (Counting)</h2>


                  <div style="margin-top: 15px; font-size: 18px; color: #666666;">
                    <div style="display: flex; gap: 20px; justify-content: center;">
                      <div style="flex: 1;">
                        <p><strong>Question for the Answerer:</strong> What is the total number of doors in the room?</p>
                        <p><strong>Options for the Answerer:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #0066cc;">
                          <li>3</li>
                          <li>2</li>
                          <li>4</li>
                          <li>1</li>
                        </ol>
                      </div>
                      <div style="flex: 1; align-content: center;">
                        <p style="font-size: 24px;"><strong style="color: #cc0000;">Helper's task is to help the Answerer to answer the question correctly.</strong></p>
                      </div>
                    </div>
                  </div>



                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #0066cc; margin-bottom: 10px;">Answerer's View</h4>
                      <img src="/inst_img/${questionType}_your_view.png"
                          alt="Your view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #cc0000; margin-bottom: 10px;">Helper's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>



                  <!-- <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_2.png"
                          alt="Your view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 16px; color: #8bd5ff; margin-top: 5px;">You see 2 lamps</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_2.png"
                          alt="Partner's view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 16px; color: #ff6b6e; margin-top: 5px;">Partner sees 3 lamps</p>
                    </div>
                  </div> -->
                  <div style="margin-top: 15px; font-size: 18px; color: #666666;">

                  </div>
                </div>


                <!-- <li style="color: #8bd5ff;"><strong>Example Question: "What is the total number of lamps in the room?"</strong><br><strong>&nbsp&nbspOptions:</strong></li>
                 <ol type="a" style="margin-left: 20px;">
                   <li style="color: #8bd5ff;"><strong>4</strong></li>
                   <li style="color: #8bd5ff;"><strong>3</strong></li>
                   <li style="color: #8bd5ff;"><strong>1</strong></li>
                   <li style="color: #8bd5ff;"><strong>2</strong></li>
                 </ol>
                <li style="color: #8bd5ff;"><strong>You have to prevent overcounting or undercounting the lamps by discussing with your partner.</strong></li>
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If you correctly answer the question, you will be rewarded with a bonus payment.</strong></li> -->
              </li>`;
            // return `<li><strong>Counting Task:</strong> <span style="color: #8bd5ff;">For instance, if the question is "How many lamps are there in the room?", you might see 1 lamp in your view and your partner might see 2 lamps in their view. Its also possible that you both might be seeing the same lamp, so you have to prevent overcounting or undercounting the lamps by discussing with your partner.</span></li>`;
          case 'spatial':
          return `<li style="color: #0066cc;"><strong>In this task, the Answerer must determine the direction of a target object from their own viewpoint.</strong></li>
                <li style="color: #0066cc;"><strong>The Answerer cannot see the object directly—it is visible only to the Helper. To identify where the object is located, the Answerer must communicate with the Helper and use the information obtained to infer its direction relative to themselves.</strong></li>
                <li style="color: #cc0000;"><strong style="color: #cc0000;">Note: Here, the directions are relative to the Answerer's own orientation, not the room layout. For example, "Behind" refers to the space directly opposite the direction the Answerer is facing.</strong></li>


                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #1a1a1a;">Task Example (Spatial Understanding)</h2>

                  <div style="margin-top: 15px; font-size: 18px; color: #666666;">
                    <div style="display: flex; gap: 20px; justify-content: center;">
                      <div style="flex: 1;">
                        <p><strong>Question for the Answerer:</strong>From your perspective, in which direction is the window that is near a brown plant container?</p>
                        <p><strong>Options for the Answerer:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #0066cc;">
                          <li>left</li>
                          <li>behind</li>
                          <li>right</li>
                          <li>front</li>
                        </ol>
                      </div>
                      <div style="flex: 1; align-content: center;">
                        <p style="font-size: 24px;"><strong style="color: #cc0000;">Helper's task is to help the Answerer to answer the question correctly.</strong></p>
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #0066cc; margin-bottom: 10px;">Answerer's View</h4>
                      <img src="/inst_img/${questionType}_your_view.png"
                          alt="Your view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #cc0000; margin-bottom: 10px;">Helper's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>

                  <!-- <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_2.png"
                          alt="Your view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 18px; margin-top: 5px;"><b style="color: #8bd5ff;">Answer:</b> a. left</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_2.png"
                          alt="Partner's view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div> -->

                </div>

                <!--
                <li style="color: #8bd5ff;"><strong>The object mentioned in the question will not be in the view of the person who has been given the question.</strong></li>
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If the question is answered correctly, both you and your partner will be rewarded with a bonus payment.</strong></li>
                -->
              </li>`;

          case 'anchor':
            return `<li style="color: #0066cc;"><strong>The task is to find the object that is common in both your and your partner's views.</strong></li>
                <li style="color: #0066cc;"><strong>Only one of the objects in the options will be common to both the views. Other objects in the options will be present in only one of the views of the room - either of the Answerer or the Helper.</strong></li>


                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #1a1a1a;">Task Example (Anchor Object Recognition)</h2>

                  <div style="margin-top: 15px; font-size: 18px; color: #666666;">
                    <div style="display: flex; gap: 20px; justify-content: center;">
                    <!-- <p><strong>Question for you:</strong> Which of the following objects is present in both your and your partner's views of the room?</p> -->
                    <!-- <div style="display: flex; gap: 80px; justify-content: center;"> -->
                      <div style="flex: 1;">
                        <p><strong>Question for the Answerer:</strong> Which of the following objects is present in both your and your partner's views of the room?</p>
                        <p><strong>Options for the Answerer:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #0066cc;">
                          <li>lamp near a window with red curtains</li>
                          <li>door near a beige lamp</li>
                          <li>computer monitor near a bed with beige bedframe</li>
                          <li>computer monitor near a dark brown cabinet</li>
                        </ol>
                      </div>
                      <div style="flex: 1; align-content: center;">
                        <p style="font-size: 24px;"><strong style="color: #cc0000;">Helper's task is to help the Answerer to answer the question correctly.</strong></p>
                      </div>
                    </div>
                  </div>


                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #0066cc; margin-bottom: 10px;">Answerer's View</h4>
                      <img src="/inst_img/${questionType}_your_view.png"
                          alt="Your view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #cc0000; margin-bottom: 10px;">Helper's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>

                  <!-- <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_1.png"
                          alt="Your view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 18px; margin-top: 5px;"><b style="color: #8bd5ff;">Answer:</b> c. square canvas wall art with gray background</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_1.png"
                          alt="Partner's view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 18px; margin-top: 5px;"><b style="color: #ff6b6e;">Answer:</b> d. artwork with abstract patterns and colors</p>
                    </div>
                  </div> -->

                </div>



                <!--<li style="color: #8bd5ff;"><strong>Example Question: "Which object appears in both your and your partner's views of the room?"</strong><br><strong>&nbsp&nbspOptions:</strong></li>
                 <ol type="a" style="margin-left: 20px;">
                   <li style="color: #8bd5ff;"><strong>rectangular black desk with white metal legs</strong></li>
                   <li style="color: #8bd5ff;"><strong>large tall wide light wood shelf with multiple compartments</strong></li>
                   <li style="color: #8bd5ff;"><strong>tall beige floor lamp with cylindrical fabric shade and metal or wooden base</strong></li>
                   <li style="color: #8bd5ff;"><strong>bed with green textured mattress and wooden frame with four cylindrical legs</strong></li>
                 </ol> -->
                 <!--
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If you correctly answer the question, you will be rewarded with a bonus payment.</strong></li>
                -->
              </li>`;

          case 'relative_distance':
            return `<li style="color: #0066cc;"><strong>The task is to find which of the objects in the options is either the farthest or the closest to the object mentioned in the question.</strong></li>
                <li style="color: #0066cc;"><strong>The objects in the options are visible either in only your view or only in your partner's view. Be careful, as what might be the closest / farthest in your view might not be the correct answer, even an object which is not at all in your view might be the correct answer.</strong></li>


                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #1a1a1a;">Task Example (Relative Distance)</h2>

                  <div style="margin-top: 15px; font-size: 18px; color: #666666;">
                    <div style="display: flex; gap: 20px; justify-content: center;">
                      <div style="flex: 1;">
                        <p><strong>Question for the Answerer:</strong>Which of the following objects is farthest from the plant container near a brown window?</p>
                        <p><strong>Options for the Answerer:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #0066cc;">
                          <li>dark brown cabinet</li>
                          <li>lamp next to a brown window</li>
                          <li>computer monitor on a white desk</li>
                          <li>desk near a window with purple curtains</li>
                        </ol>
                      </div>
                      <div style="flex: 1; align-content: center;">
                        <p style="font-size: 24px;"><strong style="color: #cc0000;">Helper's task is to help the Answerer to answer the question correctly.</strong></p>
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #0066cc; margin-bottom: 10px;">Answerer's View</h4>
                      <img src="/inst_img/${questionType}_your_view.png"
                          alt="Your view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #cc0000; margin-bottom: 10px;">Helper's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>

                  <!-- <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_2.png"
                          alt="Your view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 16px; color: #8bd5ff; margin-top: 5px;">You see the sofa and the rectangular shelf with multiple square compartments</p>
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_2.png"
                          alt="Partner's view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                      <p style="font-size: 16px; color: #ff6b6e; margin-top: 5px;">Partner sees the sofa and the tall light brown wooden shelf with two vertical columns</p>
                    </div>
                  </div> -->
                  <div style="margin-top: 15px; margin-bottom: 30px; font-size: 18px; color: #666666;">
                    <!-- <p><strong>Question:</strong> "Which item is closer to the sofa (long rectangular shape, rounded armrests, light beige patterned fabric)?"</p>
                    <p><strong>Options:</strong></p>
                      <ol type="a" style="text-align: left; list-style-position: inside; color: #8bd5ff;">
                        <li>rectangular light natural wood shelf with multiple square compartments holding small decor and paper stacks</li>
                        <li>tall light brown wooden shelf with two vertical columns containing books and small decorative items</li>
                      </ol> -->
                    <!-- <p><strong>Answer:</strong> a. rectangular light natural wood shelf with multiple square compartments holding small decor and paper stacks.</p> -->
                  </div>
                </div>



                <!-- <li style="color: #8bd5ff;"><strong>Example Question: "Which of the following objects is closer to the white wooden bookcase with two compartments, containing a pink item and small objects?"</strong><br><strong>&nbsp&nbspOptions:</strong></li>
                 <ol type="a" style="margin-left: 20px;">
                   <li style="color: #8bd5ff;"><strong>white floor lamp with a tall silver metal stand and conical fabric shade</strong></li>
                   <li style="color: #8bd5ff;"><strong>tall white wooden cabinet with two glass-paneled doors showing shelves inside</strong></li>
                 </ol> -->
                 <!--
                <li style="color: #8bd5ff;"><strong>The object mentioned in the question will be in both views. However, one of the objects in the options will only be in your view and the other object in the options will only be in your partner's view.</strong></li>
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If you correctly answer the question, you will be rewarded with a bonus payment.</strong></li>
                -->
              </li>`;

          case 'perspective_taking':
          return `<li style="color: #0066cc;"><strong>In this task, the Answerer must determine the direction of an object from the Helper's point of view.</strong></li>
                <li style="color: #0066cc;"><strong>The object is visible only to the Answerer, not to the Helper. To identify where the object lies relative to the Helper, the Answerer must communicate with the Helper and use the information obtained to infer the Helper's orientation.</strong></li>
                <li style="color: #cc0000;"><strong style="color: #cc0000;">Note: Here, directions are defined from the Helper's perspective, not the Answerer's. For example, "Front" refers to the space directly ahead of the Helper's current line of sight.</strong></li>

                <div style="margin-top: 30px; text-align: center;">
                  <h2 style="margin-bottom: 20px; color: #1a1a1a;">Task Example (Perspective Taking)</h2>

                  <div style="margin-top: 15px; font-size: 18px; color: #666666;">
                    <div style="display: flex; gap: 20px; justify-content: center;">
                      <div style="flex: 1;">
                        <p><strong>Question for the Answerer:</strong>From your partner's perspective, in which direction is the blue cabinet?</p>
                        <p><strong>Options for the Answerer:</strong></p>
                        <ol type="a" style="text-align: left; list-style-position: inside; color: #0066cc;">
                          <li>front-left</li>
                          <li>behind-right</li>
                          <li>front-right</li>
                          <li>behind-left</li>
                        </ol>
                      </div>
                      <div style="flex: 1; align-content: center;">
                        <p style="font-size: 24px;"><strong style="color: #cc0000;">Helper's task is to help the Answerer to answer the question correctly.</strong></p>
                      </div>
                    </div>
                  </div>


                  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #0066cc; margin-bottom: 10px;">Answerer's View</h4>
                      <img src="/inst_img/${questionType}_your_view.png"
                          alt="Your view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #cc0000; margin-bottom: 10px;">Helper's View</h4>
                      <img src="/inst_img/${questionType}_partner_view.png"
                          alt="Partner's view example"
                          style="border: 2px solid #d0d0d0; border-radius: 8px; max-width: 600px; height: auto;">
                    </div>
                  </div>

                  <!-- <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center;">
                      <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
                      <img src="/inst_img/${questionType}_your_view_2.png"
                          alt="Your view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">

                    </div>
                    <div style="text-align: center;">
                      <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
                      <img src="/inst_img/${questionType}_partner_view_2.png"
                          alt="Partner's view example"
                          style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 600px; height: auto;">
                        <p style="font-size: 18px; margin-top: 5px;"><b style="color: #ff6666;">Answer:</b> c. front-right</p>
                    </div>
                  </div> -->

                </div>

                <!--
                <li style="color: #8bd5ff;"><strong>The object mentioned in the question will only be in the view of the person who has been given the question. And not in the view of the other person.</strong></li>
                <li style="color: #8bd5ff;"><strong>Overall, the goal is to discuss and collaborate with your partner to determine the correct answer.</strong></li>
                <li style="color: #ff6666;"><strong style="color: #ff6666;">If the question is answered correctly, both you and your partner will be rewarded with a bonus payment.</strong></li>
                -->
              </li>`;
          case 'all_types':
            return `
            <li><strong>Counting Task:</strong> <span style="color: #0066cc;">For instance, if the question is "How many lamps are there in the room?", you might see 1 lamp in your view and your partner might see 2 lamps in their view. Its also possible that you both might be seeing the same lamp, so you have to prevent overcounting or undercounting the lamps by discussing with your partner.</span></li>
            <!-- <li><strong>Spatial Task:</strong> <span style="color: #ff6666;">For instance, if the question is "Where is the red chair located?", you might see the chair on the left side of your view while your partner sees it on the right side of their view. You need to discuss the spatial relationships and positions to determine the correct answer.</span></li> -->
            <!-- <li><strong>Anchor Task:</strong> <span style="color: #ff6666;">For anchor questions, you might see objects in different positions. Discuss the anchor object and its location with your partner.</span></li> -->
            <!-- <li><strong>Relative Distance Task:</strong> <span style="color: #ff6666;">For relative distance questions, you might see objects in different distances. Discuss the relative distance between the objects with your partner.</span></li> -->
            <!-- <li><strong>Other Tasks:</strong> <span style="color: #ff6666;">You and your partner will see different perspectives of the same scene and need to work together to solve the question correctly.</span></li> -->`;
          default:
            return `<li>You and your partner will see different perspectives of the same scene and need to work together to solve the question correctly.</li>`;
        }
      }

      // Instructions are generated dynamically based on server QUESTION_TYPE
const consentTrial = {
  type: jsPsychSurveyHtmlForm,
  html: CONSENT_HTML,
  button_label: "Continue",
  on_load: function() {
    // Track consent page start time globally
    if (typeof window !== 'undefined' && window.consentPageStartTime === undefined) {
      window.consentPageStartTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
    }
  }
};

      // Custom waiting trial plugin - register on window like other plugins
      (function() {
        class WaitingTrialPlugin {
          constructor(jsPsych) {
            this.jsPsych = jsPsych;
          }
          
          trial(display_element, trial) {
            // Store display_element reference for dynamic updates
            trial._displayElement = display_element;
            
            const updateDisplay = (message, showSpinner = true, additionalText = 'Please keep this tab open.') => {
              display_element.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                  <h2 style="color: #1a1a1a; margin-bottom: 20px;">${message}</h2>
                  ${showSpinner ? '<div class="dc-spinner"></div>' : ''}
                  <div style="font-size: 14px; color: #999999; margin-top: 20px;">
                    ${additionalText}
                  </div>
                </div>
              `;
            };
            
            updateDisplay(trial.message);
            
            if (trial.on_wait) {
              const finishTrialFn = () => {
                this.jsPsych.finishTrial();
              };
              // Store finishTrial function and updateDisplay function on the trial object
              trial._finishTrial = finishTrialFn;
              trial._updateDisplay = updateDisplay;
              trial.on_wait(finishTrialFn, updateDisplay);
            }
          }
        }
        
        WaitingTrialPlugin.info = {
          name: 'waiting-trial',
          parameters: {
            message: { type: String, default: 'Please wait...' },
            on_wait: { type: Function, default: null }
          }
        };
        
        // Register on window like other plugins
        window.jsPsychWaitingTrial = WaitingTrialPlugin;
      })();
      
      const waitingTrialPlugin = window.jsPsychWaitingTrial;

      // Waiting page for pairing
      const waitingForPairingTrial = {
        type: waitingTrialPlugin,
        message: 'Connecting to Partner',
        on_wait: function(finishTrial, updateDisplay) {
          console.log('[DyadicChat] Starting socket connection with PID:', pidFromUrl);
          console.log('[DyadicChat] finishTrial type:', typeof finishTrial, finishTrial);
          console.log('[DyadicChat] updateDisplay type:', typeof updateDisplay, updateDisplay);
          
          // Store finishTrial and updateDisplay in variables accessible in closures
          const finishTrialFn = finishTrial;
          const updateDisplayFn = updateDisplay;
          
          // Connect to socket with PID in query string (server expects this)
          // Enable automatic reconnection with exponential backoff for network resilience
          const socket = io(window.location.origin, { 
            query: { pid: pidFromUrl },
            reconnection: true,
            reconnectionDelay: 1000,        // Start with 1 second delay
            reconnectionDelayMax: 5000,      // Max 5 seconds between attempts
            reconnectionAttempts: Infinity,  // Keep trying indefinitely
            timeout: 20000,                  // Connection timeout
            transports: ['websocket', 'polling'] // Try websocket first, fallback to polling
          });
          socket.prolific = { PID: pidFromUrl };
          
          let connected = false;
          let paired = false;
          let blocked = false;
          
          // Wait for socket to connect
          socket.on('connect', () => {
            connected = true;
            console.log('[DyadicChat] Socket connected, socket ID:', socket.id, 'waiting for pairing...');
            // Hide any connection warning
            const warning = document.getElementById('dc-connection-warning');
            if (warning) warning.style.display = 'none';
          });

          // Handle reconnection events
          socket.on('disconnect', (reason) => {
            console.log('[DyadicChat] Socket disconnected:', reason);
            if (reason === 'io server disconnect' || reason === 'transport close' || reason === 'transport error') {
              // Show subtle reconnection message
              if (updateDisplayFn) {
                updateDisplayFn('Reconnecting...', true, 'Connection lost. Attempting to reconnect...');
              }
            }
          });

          socket.on('reconnect', (attemptNumber) => {
            console.log('[DyadicChat] Socket reconnected after', attemptNumber, 'attempts');
            if (updateDisplayFn) {
              updateDisplayFn('Connecting to Partner', true, 'Reconnected! Waiting for pairing...');
            }
          });

          socket.on('reconnect_attempt', (attemptNumber) => {
            console.log('[DyadicChat] Reconnection attempt', attemptNumber);
            if (updateDisplayFn) {
              updateDisplayFn('Reconnecting...', true, `Reconnecting... (attempt ${attemptNumber})`);
            }
          });
          
          socket.on('paired:instructions', (data) => {
            if (paired || blocked) return; // Prevent duplicate handling
            paired = true;
            console.log('[DyadicChat] Paired for instructions:', data);
            window.pairingData = data;
            window.userRole = data.role;
            window.serverQuestionType = data.server_question_type;
            window.maxTurns = data.maxTurns;
            socket.currentRoom = data.roomId;
            window.socket = socket; // Store socket globally
            
            // Move to instructions
            if (typeof finishTrialFn === 'function') {
              console.log('[DyadicChat] Calling finishTrial function');
              finishTrialFn();
            } else {
              console.error('[DyadicChat] finishTrial is not a function:', typeof finishTrialFn, finishTrialFn);
              // Fallback: try to finish trial using jsPsych directly
              if (window.jsPsych) {
                console.log('[DyadicChat] Using fallback: window.jsPsych.finishTrial()');
                window.jsPsych.finishTrial();
              }
            }
          });
          
          // Handle connection errors
          socket.on('connect_error', (error) => {
            console.error('[DyadicChat] Socket connection error:', error);
          });
          
          // Handle blocked events - update display instead of showing alert
          socket.on('blocked:deck_complete', () => {
            if (blocked) return;
            blocked = true;
            console.error('[DyadicChat] Blocked: deck complete');
            
            // Always update the display directly to ensure it works
            const updatePageDisplay = () => {
              // Try multiple selectors to find the display element
              let displayEl = document.querySelector('.jspsych-content');
              if (!displayEl) {
                displayEl = document.querySelector('#jspsych-content');
              }
              if (!displayEl) {
                displayEl = document.body;
              }
              
              if (displayEl) {
                displayEl.innerHTML = `
                  <div style="text-align: center; padding: 40px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <h2 style="color: #1a1a1a; margin-bottom: 20px; font-size: 28px;">Study is Full</h2>
                    <div style="font-size: 18px; color: #666666; margin-top: 20px; max-width: 600px;">
                      Sorry, the study is full. All items have been completed. You can close this tab.
                    </div>
                  </div>
                `;
                console.log('[DyadicChat] Display updated to show study is full');
              } else {
                console.error('[DyadicChat] Could not find display element to update');
              }
            };
            
            // Try using updateDisplayFn first, then fallback to direct update
            if (updateDisplayFn && typeof updateDisplayFn === 'function') {
              try {
                updateDisplayFn('Study is Full', false, 'Sorry, the study is full. All items have been completed. You can close this tab.');
              } catch (e) {
                console.error('[DyadicChat] Error calling updateDisplayFn:', e);
                updatePageDisplay();
              }
            } else {
              updatePageDisplay();
            }
          });
          
          socket.on('blocked:repeat_pid', () => {
            if (blocked) return;
            blocked = true;
            console.error('[DyadicChat] Blocked: repeat PID');
            
            // Always update the display directly to ensure it works
            const updatePageDisplay = () => {
              // Try multiple selectors to find the display element
              let displayEl = document.querySelector('.jspsych-content');
              if (!displayEl) {
                displayEl = document.querySelector('#jspsych-content');
              }
              if (!displayEl) {
                displayEl = document.body;
              }
              
              if (displayEl) {
                displayEl.innerHTML = `
                  <div style="text-align: center; padding: 40px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <h2 style="color: #1a1a1a; margin-bottom: 20px; font-size: 28px;">Already Participated</h2>
                    <div style="font-size: 18px; color: #666666; margin-top: 20px; max-width: 600px;">
                      You have already participated in this study. You can close this tab.
                    </div>
                  </div>
                `;
                console.log('[DyadicChat] Display updated to show already participated');
              } else {
                console.error('[DyadicChat] Could not find display element to update');
              }
            };
            
            // Try using updateDisplayFn first, then fallback to direct update
            if (updateDisplayFn && typeof updateDisplayFn === 'function') {
              try {
                updateDisplayFn('Already Participated', false, 'You have already participated in this study. You can close this tab.');
              } catch (e) {
                console.error('[DyadicChat] Error calling updateDisplayFn:', e);
                updatePageDisplay();
              }
            } else {
              updatePageDisplay();
            }
          });
          
          // Timeout after 5 minutes
          setTimeout(() => {
            if (!paired && !blocked) {
              console.warn('[DyadicChat] Pairing timeout after 5 minutes');
              if (updateDisplayFn && typeof updateDisplayFn === 'function') {
                updateDisplayFn('Pairing Timeout', false, 'No partner found within 5 minutes. Please refresh and try again.');
              } else {
                const displayEl = document.querySelector('.jspsych-content');
                if (displayEl) {
                  displayEl.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                      <h2 style="color: #1a1a1a; margin-bottom: 20px;">Pairing Timeout</h2>
                      <div style="font-size: 14px; color: #999999; margin-top: 20px;">
                        No partner found within 5 minutes. Please refresh and try again.
                      </div>
                    </div>
                  `;
                }
              }
            }
          }, 5 * 60 * 1000);
        }
      };

      // Waiting page for partner to finish instructions
      const waitingForPartnerInstructionsTrial = {
        type: waitingTrialPlugin,
        message: 'Waiting for your partner to finish reading the instructions...',
        on_wait: function(finishTrial) {
          // Store finishTrial in a variable accessible in closures
          const finishTrialFn = finishTrial;
          
          if (window.socket) {
            // Check if partner already finished
            let partnerReady = false;
            
            window.socket.on('instructions:partner_ready', () => {
              console.log('[DyadicChat] Partner finished instructions');
              partnerReady = true;
            });
            
            window.socket.on('instructions:both_ready', () => {
              console.log('[DyadicChat] Both users ready, proceeding to study');
              if (typeof finishTrialFn === 'function') {
                finishTrialFn();
              } else if (window.jsPsych) {
                window.jsPsych.finishTrial();
              }
            });
            
            // If partner was already ready when we got here, we might have missed the event
            // The server will send both_ready when we notify we're ready
            // So we just wait for both_ready
          } else {
            console.error('[DyadicChat] No socket available for waiting');
            // Fallback: wait a bit then proceed
            if (typeof finishTrialFn === 'function') {
              setTimeout(() => finishTrialFn(), 2000);
            } else if (window.jsPsych) {
              setTimeout(() => window.jsPsych.finishTrial(), 2000);
            }
          }
        }
      };

      // Fetch server config first, then initialize jsPsych
      async function initializeExperiment() {
        let serverConfig = { questionType: 'all_types', maxTurns: 10 };

        try {
          const response = await fetch('/api/config');
          serverConfig = await response.json();
          console.log('[DyadicChat] Server config:', serverConfig);
        } catch (error) {
          console.warn('[DyadicChat] Failed to fetch server config, using defaults:', error);
        }

        // Create instructions trial dynamically based on role
        // The role will be set by the time this trial loads (from paired:instructions event)
        function createInstructionsTrial() {
          try {
            // Get role dynamically - will be set by paired:instructions event before this trial loads
            const getRole = () => window.userRole || 'answerer'; // Default to answerer if not set
            const getQuestionType = () => window.serverQuestionType || serverConfig.questionType;
            const getMaxTurns = () => window.maxTurns || serverConfig.maxTurns;
            
            // Get initial role (might be undefined, but that's okay - will update in on_load)
            const initialRole = getRole();
            const initialQuestionType = getQuestionType();
            const initialMaxTurns = getMaxTurns();
            
            return {
              type: jsPsychInstructions,
              pages: [generateRoleSpecificInstructions(initialRole, initialQuestionType, initialMaxTurns)], // Initial placeholder
            show_clickable_nav: true,
            button_label_next: "Begin Task",
            button_label_previous: "Back",
            on_load: function() {
              // Get role and config dynamically when instructions page loads
              // At this point, paired:instructions should have already set window.userRole
              const role = getRole();
              const questionType = getQuestionType();
              const maxTurns = getMaxTurns();
              
              console.log('[DyadicChat] Loading instructions with role:', role, 'questionType:', questionType, 'maxTurns:', maxTurns);
              
              // Only update if role has changed or if we need to refresh
              // Generate the correct instructions based on current role
              const instructionsHTML = generateRoleSpecificInstructions(role, questionType, maxTurns);
              
              // Update the pages array
              this.pages = [instructionsHTML];
              
              // Update the DOM directly since the plugin has already rendered
              // The plugin creates a div with class 'instr-page' containing pages[0]
              const updateInstructions = () => {
                const instrPage = document.querySelector('.instr-page');
                if (instrPage) {
                  instrPage.innerHTML = instructionsHTML;
                  console.log('[DyadicChat] Updated instructions display with role:', role);
                  return true;
                }
                return false;
              };
              
              // Try to update immediately
              if (!updateInstructions()) {
                // If not found, try after a short delay
                setTimeout(() => {
                  if (!updateInstructions()) {
                    setTimeout(updateInstructions, 200);
                  }
                }, 100);
              }
              
              // Track instructions page start time
              if (typeof window !== 'undefined' && window.instructionsPageStartTime === undefined) {
                window.instructionsPageStartTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
              }
            },
            on_finish: function() {
              // Notify server that instructions are complete
              if (window.socket && window.socket.currentRoom) {
                console.log('[DyadicChat] Instructions finished, notifying server');
                window.socket.emit('instructions:ready');
              }
            }
            };
          } catch (e) {
            console.error('[DyadicChat] Error creating instructions trial:', e);
            // Return a fallback trial to prevent breaking the timeline
            return {
              type: jsPsychInstructions,
              pages: ['<h2>Instructions</h2><p>Please wait while instructions load...</p>'],
              show_clickable_nav: true,
              button_label_next: "Begin Task"
            };
          }
        }

        const chatTrial = {
          type: jsPsychDyadicChat,
          socketUrl: window.location.origin,
          prolific: { PID: pidFromUrl },
          min_turns: serverConfig.maxTurns, // Use server config
          goal_question: '',
          answer_options: ['A','B','C','D'],
          wait_timeout_sec: 120,
          image_url: '',
          question_type: serverConfig.questionType, // Use server config
          existingSocket: window.socket // Pass existing socket if available
        };

        // Create timeline
        const timeline = [
          consentTrial,
          waitingForPairingTrial,
          createInstructionsTrial(), // Call the function to get the trial object
          waitingForPartnerInstructionsTrial,
          chatTrial
        ];

        jsPsych.run(timeline);
      }

      // Initialize the experiment
      initializeExperiment();
    </script>
  </body>
</html>
