<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prolific Dyadic Chat</title>
    <script src="/socket.io/socket.io.js"></script>

    <!-- jsPsych core -->
    <script src="https://unpkg.com/jspsych@7.3.3/dist/index.browser.js?v=core"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/dist/style.css?v=core">

    <!-- Local plugins -->
    <script src="/plugins/jspsych-survey-html-form-lite.js?v=v7class"></script>
    <script src="/plugins/jspsych-instructions-lite.js?v=v7class"></script>
    <script src="/plugins/jspsych-dyadic-chat.js?v=vG6h-uipatch3d"></script>

    <style>
      body { margin:0; background:#000; color:#fff; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      .jspsych-content { color:#fff; }
      .jspsych-btn { background:#1f1f22; color:#fff; border:1px solid #555; border-radius:10px; padding:10px 14px; }
      a, p, li, h1, h2, h3 { color:#fff; }
      .consent-box { margin-top:20px; max-height:55vh; overflow:auto; padding:12px; border:1px solid #444; border-radius:10px; background:#0b0b0b; text-align:left; max-width:1400px; margin-left:auto; margin-right:auto; font-family: 'Arial', 'Helvetica', sans-serif; font-size:16px; line-height:1.6; }
      .consent-actions { margin-top:12px; }
      .consent-actions label { display:flex; align-items:center; gap:8px; }
      .instr { text-align:justify; max-width:1400px; margin:0 auto; padding: 0 10px; }
      .instr ul { line-height:1.6; }
      .instr h2 { margin-top:0; }
      .instr-page-top { margin-top: 24px; }
      .instr li { margin: 8px 0; }
      .instr strong { color: #8bd5ff; }
  .consent-box h2 { margin: 0 0 12px 0; }
</style>
  </head>
  <body>
    <script>
      const jsPsych = initJsPsych();
      const __qp = new URLSearchParams(location.search);
      const pidFromUrl = __qp.get('PID') || __qp.get('PROLIFIC_PID') || 'DEBUG_LOCAL';

      const CONSENT_HTML = `
        <div class="consent-box">
          <h2>Consent</h2>
          <p>Please read the information below. By checking the box, you confirm that you consent to participate in the study.</p>
          <ul>
            <li>I agree to the anonymous use of the data in research presentations, publications, and online interactive sites to illustrate the findings.</li>
            <li>I agree that the collected data could be used in related follow-up studies.</li>
            <li>I agree to the use of the data in a not-for-profit anonymous corpus for research purposes which others will have access to.</li>
            <li>I agree to not share any personal or identifying information.</li>
            <li>I understand that I can withdraw at any time by closing the window.</li>
          </ul>
          <div class="consent-actions">
            <label><input type="checkbox" name="consent" required> I have read the information and I consent to participate in the study.</label>
          </div>
        </div>`;

      // Function to generate instructions based on question type
      function generateInstructions(questionType) {
        const baseInstructions = `
<div class="instr instr-aesthetic instr-page-top" style="margin-top: 28px;">
  <style>
    .instr-aesthetic .nice { margin: 0; padding-left: 1.2em; line-height: 1.6; }
    .instr-aesthetic li { margin: 6px 0; }
    .instr-aesthetic ol[type="a"] { margin-top: 6px; }
    .instr-aesthetic h2 { margin-bottom: 10px; }
  </style>
  <h2>Instructions</h2>
  <ol class="nice">
    <li>This is a collaborative task. You will be paired with another participant to solve a question.</li>
    <li>You and your partner will each see different views of the same room.</li>
    <li>You have to chat and collaborate with your partner in order to solve the question correctly.</li>
    <li><strong>For correctly answering the question, you will be rewarded with a bonus payment.</strong></li>
    ${getQuestionTypeSpecificInstructions(questionType)}
    <li>You can submit an answer only after the required number of turns in the chat is completed.</li>
    <li>Strict turn-taking:
      <ol type="a">
        <li>Send a message only after your partner replies.</li>
        <li>No two consecutive messages from the same person.</li>
      </ol>
    </li>
    <li>You may zoom in on the image to inspect details.</li>
    <li>After the turns are completed, select the best option you think is correct and click "Submit Answer".</li>
    <li>Do not share personal information.</li>
  </ol>
  
  <div style="margin-top: 30px; text-align: center;">
    <h3 style="margin-bottom: 20px; color: #fff;">Example: Different Views of the Same Scene</h3>
    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
      <div style="text-align: center;">
        <h4 style="color: #8bd5ff; margin-bottom: 10px;">Your View</h4>
        <img src="https://via.placeholder.com/300x200/1f1f22/8bd5ff?text=Your+View+%28Count%3A+2+lamps%29" 
             alt="Your view example" 
             style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 300px; height: auto;">
        <p style="font-size: 12px; color: #8bd5ff; margin-top: 5px;">You see 2 lamps</p>
      </div>
      <div style="text-align: center;">
        <h4 style="color: #ff6b6e; margin-bottom: 10px;">Partner's View</h4>
        <img src="https://via.placeholder.com/300x200/1f1f22/ff6b6e?text=Partner+View+%28Count%3A+1+lamp%29" 
             alt="Partner's view example" 
             style="border: 2px solid #3e3e42; border-radius: 8px; max-width: 300px; height: auto;">
        <p style="font-size: 12px; color: #ff6b6e; margin-top: 5px;">Partner sees 1 lamp</p>
      </div>
    </div>
    <div style="margin-top: 15px; font-size: 14px; color: #d0d4d9;">
      <p><strong>Question:</strong> "How many lamps are there in total?"</p>
      <p><strong>Answer:</strong> 2 (not 3!) - You need to discuss to avoid counting the same lamp twice.</p>
    </div>
  </div>
  
  <p>Click "Start chat" when you are ready.</p>
</div>
`;
        return baseInstructions;
      }

      function getQuestionTypeSpecificInstructions(questionType) {
        switch(questionType) {
          case 'counting':
            return `<li>For instance, if the question is "How many lamps are there in the room?", you might see 1 lamp in your view and your partner might see 2 lamps in their view. Its also possible that you both might be seeing the same lamp, so you have to prevent overcounting or undercounting the lamps by discussing with your partner.</li>`;
          case 'spatial':
            return `<li>For instance, if the question is "Where is the red chair located?", you might see the chair on the left side of your view while your partner sees it on the right side of their view. You need to discuss the spatial relationships and positions to determine the correct answer.</li>`;
          case 'anchor':
            return `<li>For anchor questions, you might see objects in different positions. Discuss the anchor object and its location with your partner.</li>`;
          case 'relative_distance':
            return `<li>For relative distance questions, you might see objects in different distances. Discuss the relative distance between the objects with your partner.</li>`;
          case 'all_types':
            return `
            <li><strong>Counting Task:</strong> <span style="color: #ff6666;">For instance, if the question is "How many lamps are there in the room?", you might see 1 lamp in your view and your partner might see 2 lamps in their view. Its also possible that you both might be seeing the same lamp, so you have to prevent overcounting or undercounting the lamps by discussing with your partner.</span></li>
            <!-- <li><strong>Spatial Task:</strong> <span style="color: #ff6666;">For instance, if the question is "Where is the red chair located?", you might see the chair on the left side of your view while your partner sees it on the right side of their view. You need to discuss the spatial relationships and positions to determine the correct answer.</span></li> -->
            <!-- <li><strong>Anchor Task:</strong> <span style="color: #ff6666;">For anchor questions, you might see objects in different positions. Discuss the anchor object and its location with your partner.</span></li> -->
            <!-- <li><strong>Relative Distance Task:</strong> <span style="color: #ff6666;">For relative distance questions, you might see objects in different distances. Discuss the relative distance between the objects with your partner.</span></li> -->
            <!-- <li><strong>Other Tasks:</strong> <span style="color: #ff6666;">You and your partner will see different perspectives of the same scene and need to work together to solve the question correctly.</span></li> -->`; 
          default:
            return `<li>You and your partner will see different perspectives of the same scene and need to work together to solve the question correctly.</li>`;
        }
      }

      // Instructions are generated dynamically based on server QUESTION_TYPE
const consentTrial = { 
  type: jsPsychSurveyHtmlForm, 
  html: CONSENT_HTML, 
  button_label: "Continue",
  on_load: function() {
    // Track consent page start time globally
    if (typeof window !== 'undefined' && window.consentPageStartTime === undefined) {
      window.consentPageStartTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
    }
  }
};
      // Fetch server config first, then initialize jsPsych
      async function initializeExperiment() {
        let serverConfig = { questionType: 'all_types', maxTurns: 10 };
        
        try {
          const response = await fetch('/api/config');
          serverConfig = await response.json();
          console.log('[DyadicChat] Server config:', serverConfig);
        } catch (error) {
          console.warn('[DyadicChat] Failed to fetch server config, using defaults:', error);
        }

        const instructionsTrial = { 
          type: jsPsychInstructions, 
          pages: [generateInstructions(serverConfig.questionType)], // Use server config
          show_clickable_nav: true, 
          button_label_next: "Start chat", 
          button_label_previous: "Back",
          on_load: function() {
            // Track instructions page start time
            if (typeof window !== 'undefined' && window.instructionsPageStartTime === undefined) {
              window.instructionsPageStartTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
            }
          }
        };

        const chatTrial = {
          type: jsPsychDyadicChat,
          socketUrl: window.location.origin,
          prolific: { PID: pidFromUrl },
          min_turns: serverConfig.maxTurns, // Use server config
          goal_question: '',
          answer_options: ['A','B','C','D'],
          wait_timeout_sec: 120,
          image_url: '',
          question_type: serverConfig.questionType // Use server config
        };

        jsPsych.run([consentTrial, instructionsTrial, chatTrial]);
      }

      // Initialize the experiment
      initializeExperiment();
    </script>
  </body>
</html>
